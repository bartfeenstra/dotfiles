#!/usr/bin/env bash

set -Eeuo pipefail

cd "$(dirname "$0")/.."

dotfiles_root=./dotfiles
find "$dotfiles_root" | while read -r file; do
    if [ ! -f "$file" ]; then
        continue
    fi
    echo "Installing $file..."
    basename=$(basename "$file")
    target="$HOME/$basename"

    # Leave existing links intact.
    if [ -L "$target" ] && [ "$(readlink -f "$target")" = "$(readlink -f "$file")" ]; then
    echo "Skipping $file, because it already exists."
        continue
    fi

    # Archive existing files.
    if [ -f "$target" ]; then
        echo "Moving existing $target to $target.old."
        mv "$target" "$target.old"
    fi

    # Link the file.
    echo "Linking $file."
    ln -s "$(readlink -f "$dotfiles_root")/$basename" "$target"
done

# .gitconfig
touch ~/.gitconfig.local
